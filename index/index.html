<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Space Deception â€” Ultimate</title>
<style>
body{margin:0;background:#02040a;color:white;font-family:Arial;overflow:hidden}
#ui{position:fixed;top:10px;left:10px;z-index:10}
#taskbar{width:200px;height:10px;background:#333;border-radius:5px}
#taskfill{height:100%;width:0%;background:lime;border-radius:5px}
#meeting{
 display:none;position:fixed;inset:0;
 background:rgba(0,0,0,.95);text-align:center;padding-top:80px
}
button{padding:8px;margin:5px}
canvas{display:block}
</style>
</head>
<body>

<div id="ui">
  <div id="role"></div>
  <div id="cooldown"></div>
  <div id="taskbar"><div id="taskfill"></div></div>
</div>

<div id="meeting">
  <h1>MEETING</h1>
  <div id="votes"></div>
</div>

<canvas id="game"></canvas>

<script>
const c=document.getElementById("game"),ctx=c.getContext("2d");
c.width=innerWidth;c.height=innerHeight;

const keys={};
onkeydown=e=>keys[e.key.toLowerCase()]=true;
onkeyup=e=>keys[e.key.toLowerCase()]=false;

const beep=f=>{
 const a=new AudioContext(),o=a.createOscillator();
 o.frequency.value=f;o.connect(a.destination);o.start();setTimeout(()=>o.stop(),120);
};

const player={
 x:200,y:200,r:14,speed:2.4,
 role:Math.random()<.25?"IMPOSTOR":"CREWMATE",
 tasks:6,killCD:0,alive:true,
 color:localStorage.color||"cyan",
 vision:150
};

const bots=[];
for(let i=0;i<8;i++){
 bots.push({
  x:350+i*25,y:350,alive:true,
  dir:Math.random()*6,panic:0
 });
}

const walls=[
 {x:60,y:60,w:500,h:20},{x:60,y:60,w:20,h:350},
 {x:540,y:60,w:20,h:350},{x:60,y:390,w:500,h:20}
];

const tasks=[];
for(let i=0;i<6;i++)
 tasks.push({x:120+i*70,y:120+i*20,done:false});

const vents=[{x:80,y:360},{x:520,y:80}];
let lights=false,meeting=false;

const hitWall=(x,y)=>walls.some(w=>x>w.x&&x<w.x+w.w&&y>w.y&&y<w.y+w.h);

function move(){
 if(meeting||!player.alive)return;
 let nx=player.x,ny=player.y;
 if(keys.w)ny-=player.speed;
 if(keys.s)ny+=player.speed;
 if(keys.a)nx-=player.speed;
 if(keys.d)nx+=player.speed;
 if(!hitWall(nx,ny)){player.x=nx;player.y=ny}
}

function drawCircle(x,y,r,c){
 ctx.beginPath();ctx.arc(x,y,r,0,7);ctx.fillStyle=c;ctx.fill();
}

function ai(){
 bots.forEach(b=>{
  if(!b.alive)return;
  b.dir+=Math.random()-.5;
  b.x+=Math.cos(b.dir);
  b.y+=Math.sin(b.dir);
 });
}

function doTask(){
 if(player.role!=="CREWMATE"||!keys.e)return;
 tasks.forEach(t=>{
  if(!t.done&&Math.hypot(player.x-t.x,player.y-t.y)<25){
   t.done=true;player.tasks--;beep(700);
  }
 });
}

function kill(){
 if(player.role!=="IMPOSTOR"||player.killCD>0||!keys.k)return;
 bots.forEach(b=>{
  if(b.alive&&Math.hypot(player.x-b.x,player.y-b.y)<25){
   b.alive=false;player.killCD=360;beep(120);
  }
 });
}

function vent(){
 if(player.role!=="IMPOSTOR"||!keys.v)return;
 vents.forEach(v=>{
  if(Math.hypot(player.x-v.x,player.y-v.y)<20){
   const o=vents.find(x=>x!==v);
   player.x=o.x;player.y=o.y;beep(300);
  }
 });
}

function sabotage(){
 if(player.role==="IMPOSTOR"&&keys.l)lights=true;
 if(player.role==="CREWMATE"&&keys.e)lights=false;
}

function meetingCall(){
 if(keys.m||keys.r){
  meeting=true;
  document.getElementById("meeting").style.display="block";
  const v=document.getElementById("votes");v.innerHTML="";
  bots.forEach((b,i)=>{
   if(b.alive){
    const btn=document.createElement("button");
    btn.textContent="Vote Bot "+(i+1);
    btn.onclick=()=>{b.alive=false;endMeeting()};
    v.appendChild(btn);
   }
  });
 }
}

function endMeeting(){
 meeting=false;
 document.getElementById("meeting").style.display="none";
}

function draw(){
 ctx.clearRect(0,0,c.width,c.height);

 walls.forEach(w=>{ctx.fillStyle="#333";ctx.fillRect(w.x,w.y,w.w,w.h)});
 tasks.forEach(t=>drawCircle(t.x,t.y,8,t.done?"#555":"yellow"));
 vents.forEach(v=>drawCircle(v.x,v.y,10,"purple"));
 bots.forEach(b=>drawCircle(b.x,b.y,14,b.alive?"lime":"gray"));

 drawCircle(player.x,player.y,14,player.color);

 if(lights){
  ctx.fillStyle="rgba(0,0,0,.9)";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.globalCompositeOperation="destination-out";
  drawCircle(player.x,player.y,player.vision,"black");
  ctx.globalCompositeOperation="source-over";
 }
}

function loop(){
 move();ai();doTask();kill();vent();sabotage();meetingCall();
 if(player.killCD>0)player.killCD--;
 draw();

 document.getElementById("role").textContent="Role: "+player.role;
 document.getElementById("cooldown").textContent=
  player.role==="IMPOSTOR"?"Kill CD: "+Math.ceil(player.killCD/60):"";
 document.getElementById("taskfill").style.width=
  ((6-player.tasks)/6*100)+"%";

 requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
